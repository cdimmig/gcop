<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GCOP: lib/algos/gndoepv2.h Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">GCOP
   &#160;<span id="projectnumber">1.0</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_a500c0d9ec76a5160e2e420ae78a2766.html">lib</a>      </li>
      <li class="navelem"><a class="el" href="dir_d7f365b2b2b30b8fc51c9dd2bba94deb.html">algos</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">gndoepv2.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="gndoepv2_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef GCOP_GNDOEP1_H</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define GCOP_GNDOEP1_H</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="doep_8h.html">doep.h</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="lqsensorcost_8h.html">lqsensorcost.h</a>&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;unsupported/Eigen/NonLinearOptimization&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="keyword">namespace </span>gcop {
<a name="l00010"></a>00010 
<a name="l00011"></a>00011  
<a name="l00012"></a>00012   <span class="keyword">using namespace </span>std;
<a name="l00013"></a>00013   <span class="keyword">using namespace </span>Eigen;
<a name="l00014"></a>00014 
<a name="l00015"></a>00015  
<a name="l00016"></a>00016   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, 
<a name="l00017"></a>00017     <span class="keywordtype">int</span> _nx, 
<a name="l00018"></a>00018     <span class="keywordtype">int</span> _nu,
<a name="l00019"></a>00019     <span class="keywordtype">int</span> _np,
<a name="l00020"></a>00020     <span class="keywordtype">int</span> _ng,
<a name="l00021"></a>00021     <span class="keyword">typename</span> Tz,
<a name="l00022"></a>00022     <span class="keywordtype">int</span> _nz,
<a name="l00023"></a>00023     <span class="keyword">typename</span> T1,
<a name="l00024"></a>00024     <span class="keywordtype">int</span> _nx1&gt; <span class="keyword">class </span>GnCost;
<a name="l00025"></a>00025   
<a name="l00026"></a>00026   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T = VectorXd, 
<a name="l00027"></a>00027     <span class="keywordtype">int</span> _nx = Dynamic, 
<a name="l00028"></a>00028     <span class="keywordtype">int</span> _nu = Dynamic,
<a name="l00029"></a>00029     <span class="keywordtype">int</span> _np = Dynamic,
<a name="l00030"></a>00030     <span class="keywordtype">int</span> _ng = Dynamic,
<a name="l00031"></a>00031     <span class="keyword">typename</span> Tz = VectorXd,
<a name="l00032"></a>00032     <span class="keywordtype">int</span> _nz = Dynamic,
<a name="l00033"></a>00033     <span class="keyword">typename</span> T1 = T,
<a name="l00034"></a>00034     <span class="keywordtype">int</span> _nx1 = _nx&gt; 
<a name="l00035"></a><a class="code" href="classgcop_1_1GnDoep1.html">00035</a>     <span class="keyword">class </span><a class="code" href="classgcop_1_1GnDoep1.html">GnDoep1</a> : <span class="keyword">public</span> <a class="code" href="classgcop_1_1Doep.html">Doep</a>&lt;T, _nx, _nu, _np, Tz, _nz, T1, _nx1&gt; {
<a name="l00036"></a>00036     
<a name="l00037"></a>00037     <span class="keyword">typedef</span> Matrix&lt;double, _ng, 1&gt; Vectorgd;
<a name="l00038"></a>00038     <span class="keyword">typedef</span> Matrix&lt;double, _ng, _nx&gt; Matrixgxd;
<a name="l00039"></a>00039     <span class="keyword">typedef</span> Matrix&lt;double, _ng, _nu&gt; Matrixgud;
<a name="l00040"></a>00040     <span class="keyword">typedef</span> Matrix&lt;double, _ng, _np&gt; Matrixgpd;
<a name="l00041"></a>00041     
<a name="l00042"></a>00042     <span class="keyword">typedef</span> Matrix&lt;double, _nx, 1&gt; Vectornd;
<a name="l00043"></a>00043     <span class="keyword">typedef</span> Matrix&lt;double, _nu, 1&gt; Vectorcd;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     <span class="keyword">typedef</span> Matrix&lt;double, _nx, _nx&gt; Matrixnd;
<a name="l00046"></a>00046     <span class="keyword">typedef</span> Matrix&lt;double, _nx, _nu&gt; Matrixncd;
<a name="l00047"></a>00047     <span class="keyword">typedef</span> Matrix&lt;double, _nu, _nx&gt; Matrixcnd;
<a name="l00048"></a>00048     <span class="keyword">typedef</span> Matrix&lt;double, _nu, _nu&gt; Matrixcd;
<a name="l00049"></a>00049     
<a name="l00050"></a>00050     <span class="keyword">typedef</span> Matrix&lt;double, _np, 1&gt; Vectormd;
<a name="l00051"></a>00051     
<a name="l00052"></a>00052     <span class="keyword">typedef</span> Matrix&lt;double, _np, _np&gt; Matrixmd;
<a name="l00053"></a>00053     <span class="keyword">typedef</span> Matrix&lt;double, _nx, _np&gt; Matrixnmd;
<a name="l00054"></a>00054     <span class="keyword">typedef</span> Matrix&lt;double, _np, _nx&gt; Matrixmnd;    
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     <span class="keyword">typedef</span> Matrix&lt;double, _nz, 1&gt; Vectorrd;
<a name="l00057"></a>00057     <span class="keyword">typedef</span> Matrix&lt;double, _nz, _nz&gt; Matrixrd;
<a name="l00058"></a>00058     <span class="keyword">typedef</span> Matrix&lt;double, _nz, _nx&gt; Matrixrnd;
<a name="l00059"></a>00059     <span class="keyword">typedef</span> Matrix&lt;double, _nz, _nu&gt; Matrixrcd;
<a name="l00060"></a>00060     <span class="keyword">typedef</span> Matrix&lt;double, _nz, _np&gt; Matrixrmd;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <span class="keyword">typedef</span> void(*Func_type)(<span class="keyword">const</span> T &amp;, T1 &amp;);
<a name="l00063"></a>00063 
<a name="l00064"></a>00064   <span class="keyword">public</span>:
<a name="l00093"></a>00093     <a class="code" href="classgcop_1_1GnDoep1.html">GnDoep1</a>(<a class="code" href="classgcop_1_1System.html">System&lt;T, _nx, _nu, _np&gt;</a> &amp;sys, <a class="code" href="classgcop_1_1Sensor.html">Sensor&lt;T1, _nx1, _nu, _np, Tz, _nz&gt;</a> &amp;sensor,
<a name="l00094"></a>00094            <a class="code" href="classgcop_1_1LqSensorCost.html">LqSensorCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz&gt;</a> &amp;cost, 
<a name="l00095"></a>00095            vector&lt;double&gt; &amp;ts, vector&lt;T&gt; &amp;xs, vector&lt;Vectorcd&gt; &amp;us, Vectormd &amp;p,
<a name="l00096"></a>00096            vector&lt;double&gt; &amp;ts1, Func_type _project=NULL, <span class="keywordtype">bool</span> update = <span class="keyword">true</span>);
<a name="l00097"></a>00097     
<a name="l00098"></a>00098     <span class="keyword">virtual</span> ~<a class="code" href="classgcop_1_1GnDoep1.html">GnDoep1</a>();
<a name="l00099"></a>00099 
<a name="l00104"></a>00104     <span class="keywordtype">void</span> Iterate();
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="classgcop_1_1GnDoep1.html#a1624d5709459a332cdc2004729c0d787">00106</a>     <span class="keywordtype">int</span> <a class="code" href="classgcop_1_1GnDoep1.html#a1624d5709459a332cdc2004729c0d787">info</a>;
<a name="l00107"></a><a class="code" href="classgcop_1_1GnDoep1.html#a13c16aebdaf90c91d3da72eb68b03560">00107</a>     <span class="keywordtype">double</span> <a class="code" href="classgcop_1_1GnDoep1.html#a13c16aebdaf90c91d3da72eb68b03560">fnorm</a>, covfac;
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="classgcop_1_1GnDoep1.html#a896f46fc5bdfce3c67a334090c369f5d">00109</a>     <span class="keywordtype">int</span> <a class="code" href="classgcop_1_1GnDoep1.html#a896f46fc5bdfce3c67a334090c369f5d">inputs</a>;
<a name="l00110"></a><a class="code" href="classgcop_1_1GnDoep1.html#abf633f017ac8ace4a63adfc37e31fdae">00110</a>     <span class="keywordtype">int</span> <a class="code" href="classgcop_1_1GnDoep1.html#abf633f017ac8ace4a63adfc37e31fdae">values</a>;
<a name="l00111"></a>00111     
<a name="l00112"></a><a class="code" href="classgcop_1_1GnDoep1.html#a933ffec1b8c6e03fd8f3fbc5e3b34927">00112</a>     VectorXd <a class="code" href="classgcop_1_1GnDoep1.html#a933ffec1b8c6e03fd8f3fbc5e3b34927" title="optimization vector">s</a>;  
<a name="l00113"></a>00113     
<a name="l00114"></a><a class="code" href="classgcop_1_1GnDoep1.html#af8f4d273f60322037e9aedc6564433c8">00114</a>     <a class="code" href="structgcop_1_1GnCost.html">GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;</a> *<a class="code" href="classgcop_1_1GnDoep1.html#af8f4d273f60322037e9aedc6564433c8">functor</a>;
<a name="l00115"></a><a class="code" href="classgcop_1_1GnDoep1.html#aa2964a52c46f3f8fcf6f2676cad667b1">00115</a>     NumericalDiff&lt;GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt; &gt; *<a class="code" href="classgcop_1_1GnDoep1.html#aa2964a52c46f3f8fcf6f2676cad667b1">numDiff</a>;
<a name="l00116"></a><a class="code" href="classgcop_1_1GnDoep1.html#ad8a6520e82022788a6d399a7bb3541d4">00116</a>     LevenbergMarquardt&lt;NumericalDiff&lt;GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt; &gt; &gt; *<a class="code" href="classgcop_1_1GnDoep1.html#ad8a6520e82022788a6d399a7bb3541d4">lm</a>;
<a name="l00117"></a>00117   };
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   
<a name="l00120"></a>00120 <span class="comment">// Generic functor</span>
<a name="l00121"></a>00121 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Scalar, <span class="keywordtype">int</span> NX=Dynamic, <span class="keywordtype">int</span> NY=Dynamic&gt;
<a name="l00122"></a>00122 <span class="keyword">struct </span><a class="code" href="structgcop_1_1Functor.html">Functor</a>
<a name="l00123"></a>00123 {
<a name="l00124"></a><a class="code" href="structgcop_1_1Functor.html#aba61602f116d12511a4d0605eca51719">00124</a>   <span class="keyword">typedef</span> _Scalar <a class="code" href="structgcop_1_1Functor.html#aba61602f116d12511a4d0605eca51719">Scalar</a>;
<a name="l00125"></a>00125   <span class="keyword">enum</span> {
<a name="l00126"></a>00126     InputsAtCompileTime = NX,
<a name="l00127"></a>00127     ValuesAtCompileTime = NY
<a name="l00128"></a>00128   };
<a name="l00129"></a><a class="code" href="structgcop_1_1Functor.html#a2200de1032efa12a3febae21910fa0f3">00129</a>   <span class="keyword">typedef</span> Matrix&lt;Scalar,InputsAtCompileTime,1&gt; <a class="code" href="structgcop_1_1Functor.html#a2200de1032efa12a3febae21910fa0f3">InputType</a>;
<a name="l00130"></a><a class="code" href="structgcop_1_1Functor.html#a3c3b393c259c4df7d7a3c02afe4bc27b">00130</a>   <span class="keyword">typedef</span> Matrix&lt;Scalar,ValuesAtCompileTime,1&gt; <a class="code" href="structgcop_1_1Functor.html#a3c3b393c259c4df7d7a3c02afe4bc27b">ValueType</a>;
<a name="l00131"></a><a class="code" href="structgcop_1_1Functor.html#aec710e6b8ff43c29dbf0aa631e8b71cf">00131</a>   <span class="keyword">typedef</span> Matrix&lt;Scalar,ValuesAtCompileTime,InputsAtCompileTime&gt; <a class="code" href="structgcop_1_1Functor.html#aec710e6b8ff43c29dbf0aa631e8b71cf">JacobianType</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="keyword">const</span> <span class="keywordtype">int</span> m_inputs, m_values;
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="structgcop_1_1Functor.html#a8eea2ffd5bc25312e15b1ccc5d765986">00135</a>   <a class="code" href="structgcop_1_1Functor.html#a8eea2ffd5bc25312e15b1ccc5d765986">Functor</a>() : m_inputs(InputsAtCompileTime), m_values(ValuesAtCompileTime) {}
<a name="l00136"></a><a class="code" href="structgcop_1_1Functor.html#a02151d7da11b9ee0e3753e884a29eb59">00136</a>   <a class="code" href="structgcop_1_1Functor.html#a02151d7da11b9ee0e3753e884a29eb59">Functor</a>(<span class="keywordtype">int</span> inputs, <span class="keywordtype">int</span> values) : m_inputs(inputs), m_values(values) {}
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="structgcop_1_1Functor.html#aebc56617353ad92c0699da330f319945">00138</a>   <span class="keywordtype">int</span> <a class="code" href="structgcop_1_1Functor.html#aebc56617353ad92c0699da330f319945">inputs</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_inputs; }
<a name="l00139"></a><a class="code" href="structgcop_1_1Functor.html#a10f63ca48a8d2837301169703be15296">00139</a>   <span class="keywordtype">int</span> <a class="code" href="structgcop_1_1Functor.html#a10f63ca48a8d2837301169703be15296">values</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_values; }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="comment">// you should define that in the subclass :</span>
<a name="l00142"></a>00142 <span class="comment">//  void operator() (const InputType&amp; x, ValueType* v, JacobianType* _j=0) const;</span>
<a name="l00143"></a>00143 };
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 
<a name="l00146"></a>00146  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, 
<a name="l00147"></a>00147    <span class="keywordtype">int</span> _nx = Dynamic,
<a name="l00148"></a>00148    <span class="keywordtype">int</span> _nu = Dynamic,
<a name="l00149"></a>00149    <span class="keywordtype">int</span> _np = Dynamic,
<a name="l00150"></a>00150    <span class="keywordtype">int</span> _ng = Dynamic,
<a name="l00151"></a>00151    <span class="keyword">typename</span> Tz=VectorXd,
<a name="l00152"></a>00152    <span class="keywordtype">int</span> _nz = Dynamic,
<a name="l00153"></a>00153    <span class="keyword">typename</span> T1 = T,
<a name="l00154"></a>00154    <span class="keywordtype">int</span> _nx1 = _nx&gt;
<a name="l00155"></a>00155    <span class="keyword">struct </span>GnCost : Functor&lt;double&gt; {  
<a name="l00156"></a><a class="code" href="structgcop_1_1GnCost.html#a41ab387d8327e6844394f3743ce09ab0">00156</a>    <a class="code" href="structgcop_1_1GnCost.html">GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;</a>(<span class="keywordtype">int</span> inputs, <span class="keywordtype">int</span> values) : <a class="code" href="structgcop_1_1Functor.html">Functor&lt;double&gt;</a>(inputs, values) {};
<a name="l00157"></a>00157    
<a name="l00158"></a>00158    <a class="code" href="classgcop_1_1GnDoep1.html">GnDoep1&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;</a> *doep;
<a name="l00159"></a>00159    
<a name="l00160"></a><a class="code" href="structgcop_1_1GnCost.html#a5eae924e410b47f9d62b348553ed363f">00160</a>    <span class="keyword">typedef</span> Matrix&lt;double, _nx, 1&gt; <a class="code" href="structgcop_1_1GnCost.html#a5eae924e410b47f9d62b348553ed363f">Vectornd</a>;
<a name="l00161"></a><a class="code" href="structgcop_1_1GnCost.html#ae8dbdecae476a69f87dd812adb168721">00161</a>    <span class="keyword">typedef</span> Matrix&lt;double, _np, 1&gt; <a class="code" href="structgcop_1_1GnCost.html#ae8dbdecae476a69f87dd812adb168721">Vectormd</a>;
<a name="l00162"></a><a class="code" href="structgcop_1_1GnCost.html#a37400c6ae03a145d0b4c2fb43a5555eb">00162</a>    <span class="keyword">typedef</span> Matrix&lt;double, _nu, 1&gt; <a class="code" href="structgcop_1_1GnCost.html#a37400c6ae03a145d0b4c2fb43a5555eb">Vectorcd</a>;
<a name="l00163"></a><a class="code" href="structgcop_1_1GnCost.html#a51e8ba8046ab5678b77a6d39ffa7a48a">00163</a>    <span class="keyword">typedef</span> Matrix&lt;double, _ng, 1&gt; <a class="code" href="structgcop_1_1GnCost.html#a51e8ba8046ab5678b77a6d39ffa7a48a">Vectorgd</a>;
<a name="l00164"></a><a class="code" href="structgcop_1_1GnCost.html#aa1ed43ae8f4527ac72b26c03f0b515cc">00164</a>    <span class="keyword">typedef</span> Matrix&lt;double, _nz, 1&gt; <a class="code" href="structgcop_1_1GnCost.html#aa1ed43ae8f4527ac72b26c03f0b515cc">Vectorrd</a>;
<a name="l00165"></a>00165    
<a name="l00166"></a><a class="code" href="structgcop_1_1GnCost.html#a9710eca309a75c109950cd5f4776736f">00166</a>    <span class="keywordtype">int</span> operator()(<span class="keyword">const</span> VectorXd &amp;s, VectorXd &amp;fvec)<span class="keyword"> const</span>
<a name="l00167"></a>00167 <span class="keyword">   </span>{
<a name="l00168"></a>00168      assert(doep);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170      <span class="keyword">const</span> <span class="keywordtype">int</span> &amp;<a class="code" href="camera_8h.html#a2bae77253fba36eb9bf93d4c45e4ff79">np</a> = doep-&gt;sys.P.n;
<a name="l00171"></a>00171      <span class="keyword">const</span> <span class="keywordtype">int</span> &amp;nz = doep-&gt;sensor.Z.n;
<a name="l00172"></a>00172      <span class="keyword">const</span> <span class="keywordtype">int</span> &amp;nw = doep-&gt;sys.X.n;
<a name="l00173"></a>00173      <span class="keyword">const</span> <span class="keywordtype">int</span> N = doep-&gt;us.size();
<a name="l00174"></a>00174 
<a name="l00175"></a>00175      <span class="comment">//Update inputs: process noise ws[i], p:</span>
<a name="l00176"></a>00176      doep-&gt;p = s;
<a name="l00177"></a>00177      <span class="comment">//Update sensor measurements using the input parameters and noise ws:</span>
<a name="l00178"></a>00178      doep-&gt;Update(<span class="keyword">false</span>);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180      <a class="code" href="structgcop_1_1GnCost.html#a51e8ba8046ab5678b77a6d39ffa7a48a">Vectorgd</a> &amp;g = ((<a class="code" href="classgcop_1_1LsSensorCost.html">LsSensorCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz&gt;</a>&amp;)doep-&gt;cost).g;
<a name="l00181"></a>00181      <a class="code" href="structgcop_1_1GnCost.html#ae8dbdecae476a69f87dd812adb168721">Vectormd</a> &amp;gp = ((<a class="code" href="classgcop_1_1LsSensorCost.html">LsSensorCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz&gt;</a>&amp;)doep-&gt;cost).gp;
<a name="l00182"></a>00182      fvec.tail(np).setZero();
<a name="l00183"></a>00183 
<a name="l00184"></a>00184      <span class="comment">//Compute and set residuals</span>
<a name="l00185"></a>00185      <span class="keywordtype">int</span> i = 0;
<a name="l00186"></a>00186      <span class="keywordtype">int</span> sensor_index = 0;
<a name="l00187"></a>00187      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 0; k&lt; N; ++k)
<a name="l00188"></a>00188      {
<a name="l00189"></a>00189        <span class="keywordtype">double</span> h = doep-&gt;ts[k+1] - doep-&gt;ts[k];
<a name="l00190"></a>00190        <span class="comment">//getchar();</span>
<a name="l00191"></a>00191        <span class="keywordflow">while</span>((doep-&gt;ts1[sensor_index] - doep-&gt;ts[k])&gt;= 0 &amp;&amp; (doep-&gt;ts1[sensor_index] - doep-&gt;ts[k+1]) &lt; 0)<span class="comment">//Nearest state to find the sensor measurement</span>
<a name="l00192"></a>00192        {
<a name="l00193"></a>00193          ((<a class="code" href="classgcop_1_1LqSensorCost.html">LqSensorCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz&gt;</a>&amp;)doep-&gt;cost).Res(g, doep-&gt;ts[k], doep-&gt;zs[sensor_index], doep-&gt;ws[k], doep-&gt;p, h, sensor_index);
<a name="l00194"></a>00194          fvec.segment(i,nz) = g.segment(nw,nz);
<a name="l00195"></a>00195          i += nz;
<a name="l00196"></a>00196          sensor_index = sensor_index &lt; (doep-&gt;ts1.size()-1)?sensor_index+1:sensor_index;
<a name="l00197"></a>00197          <span class="keywordflow">if</span>(sensor_index == (doep-&gt;ts1.size()-1))
<a name="l00198"></a>00198            <span class="keywordflow">break</span>;
<a name="l00199"></a>00199          fvec.tail(np) += g.tail(np);<span class="comment">//The tail is a constant residual for parameters</span>
<a name="l00200"></a>00200        }
<a name="l00201"></a>00201        <span class="comment">//cout&lt;&lt;&quot;doep-&gt;ts: &quot;&lt;&lt;(doep-&gt;ts1[sensor_index])&lt;&lt;&quot;\t&quot;&lt;&lt;(doep-&gt;ts[k])&lt;&lt;&quot;\t&quot;&lt;&lt;(doep-&gt;ts[k+1])&lt;&lt;endl;</span>
<a name="l00202"></a>00202        <span class="comment">//getchar();</span>
<a name="l00203"></a>00203        <span class="comment">//cout&lt;&lt;&quot;Res: &quot;&lt;&lt;g&lt;&lt;endl;</span>
<a name="l00204"></a>00204        <span class="comment">//cout&lt;&lt;&quot;i: &quot;&lt;&lt;i&lt;&lt;endl;</span>
<a name="l00205"></a>00205      }
<a name="l00206"></a>00206      assert(sensor_index == (doep-&gt;ts1.size()-1));<span class="comment">//Assert that we collected all the sensor data</span>
<a name="l00207"></a>00207      ((<a class="code" href="classgcop_1_1LqSensorCost.html">LqSensorCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz&gt;</a>&amp;)doep-&gt;cost).Resp(gp, doep-&gt;p);
<a name="l00208"></a>00208      fvec.tail(np) += gp;
<a name="l00209"></a>00209      <span class="comment">//cout&lt;&lt;&quot;Gp: &quot;&lt;&lt;gp&lt;&lt;endl;//#DEBUG</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211      <span class="keywordflow">if</span>(doep-&gt;debug)
<a name="l00212"></a>00212      {
<a name="l00213"></a>00213        std::cout&lt;&lt;<span class="stringliteral">&quot;Input: &quot;</span>&lt;&lt;s.transpose()&lt;&lt;endl;
<a name="l00214"></a>00214        std::cout&lt;&lt;<span class="stringliteral">&quot;Fvec: &quot;</span>&lt;&lt;fvec.transpose()&lt;&lt;endl;
<a name="l00215"></a>00215        <span class="comment">//std::cout&lt;&lt;&quot;Resp: &quot;&lt;&lt;fvec.tail(np).transpose()&lt;&lt;&quot;\t&quot;&lt;&lt;doep-&gt;p&lt;&lt;endl;</span>
<a name="l00216"></a>00216      }
<a name="l00217"></a>00217        std::cout&lt;&lt;<span class="stringliteral">&quot;Cost: &quot;</span>&lt;&lt;0.5*(fvec.transpose()*fvec)&lt;&lt;endl;
<a name="l00218"></a>00218      <span class="keywordflow">return</span> 0;
<a name="l00219"></a>00219    }
<a name="l00220"></a>00220   };
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="keyword">using namespace </span>std;
<a name="l00223"></a>00223   <span class="keyword">using namespace </span>Eigen;
<a name="l00224"></a>00224   
<a name="l00225"></a>00225   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keywordtype">int</span> _nx, <span class="keywordtype">int</span> _nu, <span class="keywordtype">int</span> _np, <span class="keywordtype">int</span> _ng, <span class="keyword">typename</span> Tz, <span class="keywordtype">int</span> _nz, <span class="keyword">typename</span> T1, <span class="keywordtype">int</span> _nx1&gt; 
<a name="l00226"></a><a class="code" href="classgcop_1_1GnDoep1.html#a7ba43f259602ea8c06194b14314a69ec">00226</a>     <a class="code" href="classgcop_1_1GnDoep1.html">GnDoep1&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;::GnDoep1</a>(<a class="code" href="classgcop_1_1System.html">System&lt;T, _nx, _nu, _np&gt;</a> &amp;sys, <a class="code" href="classgcop_1_1Sensor.html">Sensor&lt;T1, _nx1, _nu, _np, Tz, _nz&gt;</a> &amp;sensor,
<a name="l00227"></a>00227                                                 <a class="code" href="classgcop_1_1LqSensorCost.html">LqSensorCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz&gt;</a> &amp;cost,
<a name="l00228"></a>00228                                                 vector&lt;double&gt; &amp;ts, 
<a name="l00229"></a>00229                                                 vector&lt;T&gt; &amp;xs, 
<a name="l00230"></a>00230                                                 vector&lt;Vectorcd &gt; &amp;us,
<a name="l00231"></a>00231                                                 Vectormd &amp;p,
<a name="l00232"></a>00232                                                 vector&lt;double&gt; &amp;ts1,
<a name="l00233"></a>00233                                                 Func_type _project,
<a name="l00234"></a>00234                                                 <span class="keywordtype">bool</span> update) : 
<a name="l00235"></a>00235     <a class="code" href="classgcop_1_1Doep.html">Doep</a>&lt;T, _nx, _nu, _np, Tz, _nz, T1, _nx1&gt;(sys, sensor, cost, ts, xs, us, p, ts1, _project, false),
<a name="l00236"></a>00236     inputs(sys.P.n),
<a name="l00237"></a>00237     values((sensor.Z.n)*ts1.size()+sys.P.n), s(inputs), 
<a name="l00238"></a>00238     functor(0), numDiff(0), lm(0)
<a name="l00239"></a>00239     {
<a name="l00240"></a>00240       cout &lt;&lt;<span class="stringliteral">&quot;inputs=&quot;</span> &lt;&lt;<a class="code" href="classgcop_1_1GnDoep1.html#a896f46fc5bdfce3c67a334090c369f5d">inputs</a>&lt;&lt;<span class="stringliteral">&quot; values= &quot;</span>&lt;&lt;<a class="code" href="classgcop_1_1GnDoep1.html#abf633f017ac8ace4a63adfc37e31fdae">values</a>&lt;&lt; endl;
<a name="l00241"></a>00241       <span class="keywordflow">if</span>(update)
<a name="l00242"></a>00242       {
<a name="l00243"></a>00243         this-&gt;<a class="code" href="classgcop_1_1Doep.html#a8d85b61c588e3065b404ea75b8e3b0e2">Update</a>(<span class="keyword">false</span>);
<a name="l00244"></a>00244       }
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246   
<a name="l00247"></a>00247   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keywordtype">int</span> _nx, <span class="keywordtype">int</span> _nu, <span class="keywordtype">int</span> _np, <span class="keywordtype">int</span> _ng, <span class="keyword">typename</span> Tz, <span class="keywordtype">int</span> _nz, <span class="keyword">typename</span> T1, <span class="keywordtype">int</span> _nx1&gt; 
<a name="l00248"></a><a class="code" href="classgcop_1_1GnDoep1.html#a3552123328e0d5aa1935f02c179c6dde">00248</a>     <a class="code" href="classgcop_1_1GnDoep1.html#a3552123328e0d5aa1935f02c179c6dde">GnDoep1&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;::~GnDoep1</a>()
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250       <span class="keyword">delete</span> lm;
<a name="l00251"></a>00251       <span class="keyword">delete</span> numDiff;
<a name="l00252"></a>00252       <span class="keyword">delete</span> functor;
<a name="l00253"></a>00253     }  
<a name="l00254"></a>00254   
<a name="l00255"></a>00255   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keywordtype">int</span> _nx, <span class="keywordtype">int</span> _nu, <span class="keywordtype">int</span> _np, <span class="keywordtype">int</span> _ng, <span class="keyword">typename</span> Tz, <span class="keywordtype">int</span> _nz, <span class="keyword">typename</span> T1, <span class="keywordtype">int</span> _nx1&gt; 
<a name="l00256"></a><a class="code" href="classgcop_1_1GnDoep1.html#a1952799fbe79ec3af0ae8648712ee113">00256</a>     <span class="keywordtype">void</span> <a class="code" href="classgcop_1_1GnDoep1.html#a1952799fbe79ec3af0ae8648712ee113">GnDoep1&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;::Iterate</a>() {
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (!lm) {
<a name="l00259"></a>00259       functor = <span class="keyword">new</span> <a class="code" href="structgcop_1_1GnCost.html">GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt;</a>(inputs, values);
<a name="l00260"></a>00260       functor-&gt;<a class="code" href="structgcop_1_1GnCost.html#a7ca81e74937c51285d8864dbf6041d4a">doep</a> = <span class="keyword">this</span>;
<a name="l00261"></a>00261       numDiff = <span class="keyword">new</span> NumericalDiff&lt;GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt; &gt;(*functor,1e-12);
<a name="l00262"></a>00262       lm = <span class="keyword">new</span> LevenbergMarquardt&lt;NumericalDiff&lt;GnCost&lt;T, _nx, _nu, _np, _ng, Tz, _nz, T1, _nx1&gt; &gt; &gt;(*numDiff);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264       <span class="comment">//Set doep noise to zero redundancy:</span>
<a name="l00265"></a>00265       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0;i&lt;(this-&gt;ws.size());i++)
<a name="l00266"></a>00266         this-&gt;ws[i].setZero();
<a name="l00267"></a>00267 
<a name="l00268"></a>00268       <span class="keyword">const</span> <span class="keywordtype">int</span> &amp;<a class="code" href="camera_8h.html#a2bae77253fba36eb9bf93d4c45e4ff79">np</a> = this-&gt;sys.P.n;
<a name="l00269"></a>00269       s = this-&gt;p;<span class="comment">//Set the system parameters to initial guess</span>
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/*</span>
<a name="l00273"></a>00273 <span class="comment">    for (int i = 0, k = 0; k &lt; this-&gt;us.size(); ++k) {</span>
<a name="l00274"></a>00274 <span class="comment">      memcpy(s.data() + i, this-&gt;us[k].data(), this-&gt;sys.U.n*sizeof(double));</span>
<a name="l00275"></a>00275 <span class="comment">      i += this-&gt;sys.U.n;</span>
<a name="l00276"></a>00276 <span class="comment">    }</span>
<a name="l00277"></a>00277 <span class="comment">    */</span>
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="comment">//    lm.parameters.maxfev=10000;</span>
<a name="l00280"></a>00280     info = lm-&gt;minimize(s);
<a name="l00281"></a>00281     
<a name="l00282"></a>00282     cout &lt;&lt;<span class="stringliteral">&quot;info=&quot;</span>&lt;&lt;info &lt;&lt;endl;
<a name="l00283"></a>00283     <span class="comment">// check return values</span>
<a name="l00284"></a>00284     <span class="comment">// VERIFY_IS_EQUAL(info, 1);</span>
<a name="l00285"></a>00285     <span class="comment">//   VERIFY_IS_EQUAL(lm.nfev(), 26);</span>
<a name="l00286"></a>00286   }
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="preprocessor">#endif</span>
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 13 2015 21:58:47 for GCOP by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
